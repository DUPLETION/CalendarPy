import os
import json
from pathlib import Path

def get_data_file(activity):
    return Path(activity.getFilesDir()) / "progress.json"

def load_progress(activity):
    data_file = get_data_file(activity)
    if data_file.exists():
        with open(data_file, 'r') as f:
            return json.load(f)
    return {
        'current_week': "Неделя 1 — База Python",
        'current_day': 1,
        'completed_days': {}
    }

def save_progress(activity, data):
    data_file = get_data_file(activity)
    with open(data_file, 'w') as f:
        json.dump(data, f)

DAYS_DATA = {
    "Неделя 1 — База Python": {
        1: {
            "title": "День 1: Установка Python и переменные",
            "theory": "Установка Python, Что такое интерпретатор, Функция print(), Переменные, Типы данных: int (целые числа), float (дробные), str (строки), bool (логические)",
            "practice": "Калькулятор двух чисел",
            "tasks": "Настроить рабочее окружение, Написать калькулятор для сложения двух чисел"
        },
        2: {
            "title": "День 2: Ввод данных и преобразование типов",
            "theory": "Ввод данных input(), Преобразование типов (int(), float(), str()), Арифметические операции, f-строки для форматирования",
            "practice": "Мини-программа 'анкета пользователя'",
            "tasks": "Создать программу с вводом имени, возраста, города и выводом анкеты"
        },
        3: {
            "title": "День 3: Условные операторы",
            "theory": "Условные операторы: if (если), elif (иначе если), else (иначе), Логические операторы: and (и), or (или), not (не)",
            "practice": "Программа проверки возраста",
            "tasks": "Написать программу категоризации по возрасту: ребёнок, подросток, взрослый, пожилой"
        },
        4: {
            "title": "День 4: Циклы",
            "theory": "Цикл while (пока истинно), Цикл for (для каждого элемента), Функция range(), Операторы break (выход) и continue (следующая итерация)",
            "practice": "Таблица умножения, Игра 'Угадай число'",
            "tasks": "Вывести таблицу умножения на 5, Создать игру угадай число с подсказками 'больше/меньше'"
        },
        5: {
            "title": "День 5: Списки",
            "theory": "Списки (list) - упорядоченные коллекции, Индексы (начиная с 0), Срезы [start:end], Методы списков: append(), remove(), pop(), len()",
            "practice": "Программа 'Список покупок'",
            "tasks": "Создать программу добавления и удаления товаров из списка покупок"
        },
        6: {
            "title": "День 6: Мини-проект",
            "theory": "Закрепление пройденного материала: переменные, ввод/вывод, условия, циклы, списки",
            "practice": "Консольная игра 'Камень-ножницы-бумага'",
            "tasks": "Создать игру против компьютера с подсчётом очков"
        }
    },
    "Неделя 2 — Структуры данных и функции": {
        1: {
            "title": "День 1: Кортежи, множества, словари",
            "theory": "Кортежи (tuple) - неизменяемые списки, Множества (set) - уникальные элементы, Словари (dict) - пары ключ-значение",
            "practice": "Телефонная книга",
            "tasks": "Создать словарь контактов с поиском по имени"
        },
        2: {
            "title": "День 2: Функции",
            "theory": "Функции - блок кода для многократного использования, Оператор return для возврата значения, Аргументы: позиционные и именованные",
            "practice": "Калькулятор через функции",
            "tasks": "Создать функции для базовых операций: сложение, вычитание, умножение, деление"
        },
        3: {
            "title": "День 3: Область видимости и рекурсия",
            "theory": "Область видимости: глобальные и локальные переменные, Понятие рекурсии - функция вызывает саму себя, Базовая проверка для выхода",
            "practice": "Рекурсивная функция вычисления факториала",
            "tasks": "Вычислить факториал рекурсивно, Вычислить число Фибоначчи"
        },
        4: {
            "title": "День 4: Работа со строками",
            "theory": "Методы строк: split() (разделить), join() (соединить), upper() (заглавные), lower() (строчные), strip() (убрать пробелы), replace() (заменить)",
            "practice": "Анализатор текста",
            "tasks": "Подсчитать количество слов, символов, найти самое длинное слово в тексте"
        },
        5: {
            "title": "День 5: Работа с файлами",
            "theory": "Функция open() для открытия файла, Режимы: 'r' (чтение), 'w' (запись), 'a' (добавление), Контекстный менеджер with для автоматического закрытия",
            "practice": "Сохранение списка дел в файл",
            "tasks": "Создать программу которая сохраняет и загружает задачи из файла"
        },
        6: {
            "title": "День 6: Мини-проект",
            "theory": "Повторение: словари, функции, работа с файлами",
            "practice": "To-Do лист с сохранением в файл",
            "tasks": "Полноценное приложение списка дел с добавлением, удалением и сохранением"
        }
    },
    "Неделя 3 — ООП": {
        1: {
            "title": "День 1: Классы и объекты",
            "theory": "Класс - шаблон для создания объектов, Объект - экземпляр класса, Метод __init__ - конструктор для инициализации атрибутов",
            "practice": "Создание класса Человек",
            "tasks": "Создать класс Человек с атрибутами: имя, возраст, город"
        },
        2: {
            "title": "День 2: Методы и атрибуты",
            "theory": "self - ссылка на текущий объект, Методы экземпляра - функции внутри класса, Атрибуты класса - общие для всех объектов",
            "practice": "Расширение класса Человек",
            "tasks": "Добавить методы: приветствие, рассказ о себе, день рождения"
        },
        3: {
            "title": "День 3: Наследование",
            "theory": "Наследование - создание класса на основе другого, super() - вызов методов родителя, Инкапсуляция - скрытие данных",
            "practice": "Иерархия классов",
            "tasks": "Создать класс Студент (наследует от Человек), добавить предметы и оценки"
        },
        4: {
            "title": "День 4: Магические методы",
            "theory": "__str__ - строковое представление объекта, __repr__ - представление для разработчика, __eq__ - сравнение объектов",
            "practice": "Отладка класса",
            "tasks": "Добавить магические методы в класс, научиться выводить объекты в удобном виде"
        },
        5: {
            "title": "День 5: Мини-проект ООП",
            "theory": "Практика объектно-ориентированного программирования",
            "practice": "Банковский аккаунт (класс BankAccount)",
            "tasks": "Создать класс с методами: депозит, снятие, баланс, история операций"
        },
        6: {
            "title": "День 6: Улучшение проекта",
            "theory": "Повторение концепций ООП",
            "practice": "Доработка BankAccount",
            "tasks": "Добавить историю операций, защиту от снятия больше чем есть на балансе"
        }
    },
    "Неделя 4 — Практика и алгоритмы": {
        1: {
            "title": "День 1: Сортировка пузырьком",
            "theory": "Пузырьковая сортировка (Bubble Sort) - сравнение соседних элементов, Сложность O(n^2), Обмен местами при неправильном порядке",
            "practice": "Сортировка массива пузырьком",
            "tasks": "Реализовать пузырьковую сортировку, отсортировать список чисел"
        },
        2: {
            "title": "День 2: Быстрая сортировка",
            "theory": "Быстрая сортировка (QuickSort) - рекурсивный алгоритм, Опорный элемент (pivot), Сложность O(n log n) в среднем случае",
            "practice": "Быстрая сортировка",
            "tasks": "Реализовать быструю сортировку, сравнить скорость с пузырьковой"
        },
        3: {
            "title": "День 3: Линейный и бинарный поиск",
            "theory": "Линейный поиск - проверка каждого элемента O(n), Бинарный поиск - деление пополам O(log n), Требует отсортированный массив",
            "practice": "Поиск в массиве",
            "tasks": "Реализовать линейный и бинарный поиск, найти элемент в отсортированном списке"
        },
        4: {
            "title": "День 4: Рекурсия",
            "theory": "Рекурсия - функция вызывает саму себя, Стек вызовов - память о вызовах, Базовый случай - условие выхода",
            "practice": "Рекурсивные задачи",
            "tasks": "Решить 5 задач с использованием рекурсии: факториал, сумма списка, обратная строка"
        },
        5: {
            "title": "День 5: Словари и множества",
            "theory": "Сложность операций в словарях O(1), Множества - уникальные элементы, Dict comprehension - создание словарей в одну строку",
            "practice": "Оптимизация кода",
            "tasks": "Переписать код с использованием словарей и множеств для скорости"
        },
        6: {
            "title": "День 6: Практика на LeetCode",
            "theory": "Решение алгоритмических задач",
            "practice": "Решение задач на LeetCode и Codewars",
            "tasks": "Решить 3-5 задач средней сложности"
        }
    },
    "Неделя 5 — Библиотеки": {
        1: {
            "title": "День 1: pip и установка пакетов",
            "theory": "pip - менеджер пакетов Python, Установка: pip install имя_пакета, requirements.txt - файл зависимостей проекта",
            "practice": "Установка пакетов",
            "tasks": "Установить библиотеки: requests, random, datetime"
        },
        2: {
            "title": "День 2: Работа с datetime",
            "theory": "Модуль datetime для работы с датами, Классы: date, time, datetime, timedelta - разница между датами, Форматирование strftime()",
            "practice": "Календарь событий",
            "tasks": "Создать программу учета дат, вычислить дни до события"
        },
        3: {
            "title": "День 3: requests и API",
            "theory": "Библиотека requests для HTTP запросов, Методы: GET, POST, PUT, DELETE, Работа с JSON - json.loads() и json.dumps()",
            "practice": "Курс валют",
            "tasks": "Получить курс USD/RUB через публичный API, вывести на экран"
        },
        4: {
            "title": "День 4: Работа с JSON",
            "theory": "JSON - формат данных, Чтение: json.loads() из строки, Запись: json.dumps() в строку, json.load() и json.dump() для файлов",
            "practice": "Конвертер JSON",
            "tasks": "Создать парсер JSON файлов, конвертировать JSON в Python словарь и обратно"
        },
        5: {
            "title": "День 5: random и statistics",
            "theory": "random - генерация случайных чисел, randint(), choice(), shuffle(), statistics - математическая статистика, mean(), median(), mode()",
            "practice": "Генератор паролей",
            "tasks": "Создать генератор надёжных паролей со случайными символами"
        },
        6: {
            "title": "День 6: Мини-проект",
            "theory": "Объединение изученных библиотек",
            "practice": "Погодное приложение",
            "tasks": "Создать приложение погоды с API, использовать datetime и requests"
        }
    },
    "Неделя 6 — Telegram-бот": {
        1: {
            "title": "День 1: Введение в aiogram",
            "theory": "Библиотека aiogram3 для создания ботов, Создание бота через @BotFather в Telegram, Получение токена бота",
            "practice": "Создание бота",
            "tasks": "Создать простейшего бота с командой /start, запустить бота"
        },
        2: {
            "title": "День 2: Обработчики сообщений",
            "theory": "MessageHandler для обработки сообщений, FSM (Finite State Machine) - машина состояний, Диспетчер (Dispatcher) для регистрации хендлеров",
            "practice": "Эхо-бот",
            "tasks": "Создать бота который отвечает на сообщения, добавить несколько команд"
        },
        3: {
            "title": "День 3: Клавиатуры и кнопки",
            "theory": "InlineKeyboard - кнопки в сообщении, ReplyKeyboard - кнопки под полем ввода, CallbackData - данные для callback запросов",
            "practice": "Меню бота",
            "tasks": "Добавить кнопки в бота, создать главное меню с командами"
        },
        4: {
            "title": "День 4: FSM и машина состояний",
            "theory": "FSM для сложных диалогов, Состояния (States), MemoryStorage - хранение состояний в памяти, Очистка состояний",
            "practice": "Бот-опросник",
            "tasks": "Создать бота который опрашивает пользователя пошагово"
        },
        5: {
            "title": "День 5: Работа с файлами в боте",
            "theory": "Отправка/получение файлов, Отправка фото, Получение документов, Сохранение файлов на сервере",
            "practice": "Бот с файлами",
            "tasks": "Добавить загрузку и скачивание файлов в бота"
        },
        6: {
            "title": "День 6: Мини-проект",
            "theory": "Закрепление материала по aiogram",
            "practice": "Полноценный бот",
            "tasks": "Создать бота с несколькими функциями: команды, кнопки, сохранение данных"
        }
    },
    "Неделя 7 — База данных": {
        1: {
            "title": "День 1: Введение в SQLite",
            "theory": "SQLite - легкая встроенная база данных, Подключение к БД через sqlite3, Создание таблиц - CREATE TABLE, Типы данных: INTEGER, TEXT, REAL",
            "practice": "Создание БД",
            "tasks": "Создать базу данных, создать первую таблицу с пользователями"
        },
        2: {
            "title": "День 2: Основы SQL",
            "theory": "CRUD операции: INSERT (вставка), SELECT (выборка), UPDATE (обновление), DELETE (удаление), WHERE - условия отбора",
            "practice": "Операции с БД",
            "tasks": "Выполнить все CRUD операции, потренироваться с WHERE"
        },
        3: {
            "title": "День 3: Запросы и фильтрация",
            "theory": "ORDER BY - сортировка результатов, GROUP BY - группировка, LIMIT - ограничение количества, Агрегатные функции: COUNT, SUM, AVG",
            "practice": "Фильтрация данных",
            "tasks": "Написать сложные запросы с группировкой и сортировкой"
        },
        4: {
            "title": "День 4: Связи между таблицами",
            "theory": "JOIN - объединение таблиц, Внешние ключи (FOREIGN KEY), Связи: one-to-one, one-to-many, Индексы для ускорения",
            "practice": "Связанные таблицы",
            "tasks": "Создать связанные таблицы: пользователи и их заметки"
        },
        5: {
            "title": "День 5: Python и SQLite",
            "theory": "Модуль sqlite3 в Python, Курсоры для выполнения запросов, Транзакции - группа операций, Контекстный менеджер with",
            "practice": "Интеграция с Python",
            "tasks": "Подключить SQLite к Python проекту, выполнять запросы из кода"
        },
        6: {
            "title": "День 6: Мини-проект",
            "theory": "Практика с базой данных SQLite",
            "practice": "To-Do с базой данных",
            "tasks": "Перевести To-Do приложение на SQLite, сохранять задачи в БД"
        }
    },
    "Неделя 8 — Финальный проект": {
        1: {
            "title": "День 1: Планирование проекта",
            "theory": "Выбор проекта, Написание технического задания (ТЗ), Планирование архитектуры, Определение функциональности",
            "practice": "Планирование",
            "tasks": "Написать ТЗ для финального проекта, выбрать идею"
        },
        2: {
            "title": "День 2: Реализация основы",
            "theory": "Базовая структура проекта, Создание классов и функций, Настройка окружения",
            "practice": "Создание основы",
            "tasks": "Создать базовую структуру проекта, настроить импорты"
        },
        3: {
            "title": "День 3: Реализация функций",
            "theory": "Добавление функциональности, Обработка ошибок, Логирование",
            "practice": "Добавление функций",
            "tasks": "Реализовать основные функции проекта"
        },
        4: {
            "title": "День 4: База данных",
            "theory": "Проектирование БД, Создание таблиц, Интеграция с основным приложением",
            "practice": "Подключение БД",
            "tasks": "Добавить базу данных в проект, настроить CRUD операции"
        },
        5: {
            "title": "День 5: Тестирование",
            "theory": "Отладка и тестирование, Поиск багов, Проверка граничных случаев",
            "practice": "Тестирование",
            "tasks": "Протестировать приложение, исправить найденные ошибки"
        },
        6: {
            "title": "День 6: Доработка и полировка",
            "theory": "Улучшение пользовательского опыта, Исправление багов, Документирование кода",
            "practice": "Доработка",
            "tasks": "Исправить ошибки, улучшить интерфейс, дописать комментарии"
        }
    }
}

MOTIVATIONAL_QUOTES = [
    "Каждый день приближает тебя к цели!",
    "Ты молодец, что учишься!",
    "Практика - ключ к успеху!",
    "Ошибки - это часть обучения!",
    "Ты на правильном пути!",
    "Маленькие шаги ведут к большим результатам!",
    "Сегодня ты станешь лучше, чем вчера!",
    "Программирование - это творчество!",
    "Каждая строка кода - это прогресс!",
    "Верь в себя и у тебя всё получится!"
]

NOTIFICATION_MESSAGES = [
    "Код не работает? Отлично. Ты только что нашёл ещё один способ, как НЕ надо делать.",
    "Программист — это человек, который превращает кофе в код.",
    "Ошибка — это не провал, это бесплатный урок.",
    "Каждый баг — это мини-квест.",
    "Если код заработал с первого раза — ты что-то забыл.",
    "Stack Overflow — лучший друг интроверта.",
    "Программирование — это спорт. Только вместо гантелей — переменные.",
    "Сегодня больно, завтра — senior.",
    "Чем больше ошибок, тем ближе успех.",
    "Настоящий разработчик не сдаётся — он гуглит.",
    "Если не понял — перепиши.",
    "Код не злой. Он просто честный.",
    "Программирование учит терпению лучше любой медитации.",
    "Один рабочий скрипт лучше десяти идей в голове.",
    "Пиши код так, будто его будет читать психопат с топором.",
    "Каждая строка — шаг к новой версии себя.",
    "Не бойся сложных задач — бойся застоя.",
    "Debug — это детектив без сна.",
    "Чем больше практики — тем меньше паники.",
    "Консоль не врёт.",
    "Не работает? Отлично. Теперь будет опыт.",
    "Учить код — как качать мышцы. Сначала боль, потом сила.",
    "Программисты не ошибаются — они тестируют гипотезы.",
    "Сегодня ты новичок. Через год — пример для других.",
    "Баг — это скрытая возможность стать умнее.",
    "Ctrl+C и Ctrl+V — временные костыли, не образ жизни.",
    "Код любит аккуратность.",
    "Лень автоматизируется.",
    "Если задача кажется сложной — разбей её.",
    "Ничего не понятно? Значит, начинается рост.",
    "Один вечер практики лучше недели размышлений.",
    "Программирование — это суперсила 21 века.",
    "Не сдавайся на 99% — успех на 100%.",
    "Любой профи когда-то не понимал, что такое цикл.",
    "Не сравнивай себя с senior — сравнивай с вчерашним собой.",
    "Ошибки красным — путь к зелёным галочкам.",
    "Каждая функция — это маленькая победа.",
    "Учись писать, потом — оптимизируй.",
    "Лучшая документация — твой рабочий код.",
    "Программирование — это когда думаешь больше, чем печатаешь.",
    "Код не кусается. Он просто не запускается.",
    "Каждый commit — шаг вперёд.",
    "Если устал — отдохни, но не бросай.",
    "Баги боятся терпеливых.",
    "Ты не тупишь — ты обучаешься.",
    "Даже Google когда-то не знал Python.",
    "Непонятный код — будущая головная боль.",
    "Пиши так, чтобы через месяц не страдать.",
    "Понимание приходит через практику.",
    "Главное — начать.",
    "В коде нет магии — только логика.",
    "Логика качается.",
    "Терпение — лучший фреймворк.",
    "Умение искать ошибки — половина успеха.",
    "Падаешь? Поднимайся и запускай снова.",
    "Каждый день по чуть-чуть — и ты уже далеко.",
    "Не знаешь? Узнай.",
    "Не умеешь? Научись.",
    "Не получается? Попробуй иначе.",
    "Всё сложно, пока не стало понятно.",
    "Лучший способ понять — написать самому.",
    "Комментарии спасают жизни.",
    "Код без практики — теория без силы.",
    "Не бойся спрашивать.",
    "Лучший проект — тот, что доведён до конца.",
    "Не жди мотивации — садись и пиши.",
    "Маленькие проекты делают больших разработчиков.",
    "Программирование — это мышление, а не печать.",
    "Ошибки — часть профессии.",
    "Время, вложенное в обучение, окупается.",
    "Твоя первая программа — начало пути.",
    "Неидеальный код лучше отсутствующего.",
    "Делай проще.",
    "Читай код других — пиши лучше свой.",
    "Каждый день +1% знаний.",
    "Кодируй так, будто это твой стартап.",
    "Не всё понимаешь? Это нормально.",
    "Сложные задачи делают сильных программистов.",
    "Лучший дебаггер — внимательность.",
    "Ошибка — не враг, а учитель.",
    "Не сдавайся — ты уже ближе, чем думаешь.",
    "В программировании побеждает настойчивый.",
    "Упорство — лучший алгоритм успеха.",
    "Каждая строчка — инвестиция в будущее.",
    "Учёба сегодня — свобода завтра.",
    "Ты не застрял — ты учишься.",
    "Даже самый сложный код состоит из простых шагов.",
    "Терпение + практика = результат.",
    "Начни сейчас — спасибо скажешь себе потом.",
    "Ошибки делают тебя разработчиком.",
    "Не жди идеального момента — компилятор не ждёт.",
    "Настоящий прогресс — когда вчерашние задачи кажутся лёгкими.",
    "Дисциплина сильнее вдохновения.",
    "Работает? Не трогай… но сначала пойми.",
    "Каждая неудача — шаг к мастерству.",
    "Не знаешь английский? Код всё равно на нём.",
    "Чем больше кода — тем меньше страха.",
    "Учись так, будто завтра собеседование.",
    "Сложно? Значит, растёшь.",
    "Ты сможешь. Просто продолжай писать код."
]

def get_day_info(week, day):
    week_data = DAYS_DATA.get(week, {})
    if day in week_data:
        return week_data[day]
    for key in week_data.keys():
        if isinstance(key, str) and day in range(1, 7):
            return week_data.get(key, {})
    return week_data.get(day, {})

def can_proceed(data):
    key = f"{data['current_week']}_{data['current_day']}"
    return data.get('completed_days', {}).get(key, False)

def advance_day(data):
    weeks = list(DAYS_DATA.keys())
    current_week = data.get('current_week', weeks[0])
    
    if current_week not in weeks:
        current_week = weeks[0]
    
    current_idx = weeks.index(current_week)
    week_data = DAYS_DATA[current_week]
    max_day = max(week_data.keys()) if week_data else 6
    
    current_day = data.get('current_day', 1)
    
    if current_day < max_day:
        data['current_day'] = current_day + 1
    else:
        if current_idx < len(weeks) - 1:
            current_idx += 1
            data['current_week'] = weeks[current_idx]
            data['current_day'] = 1
        else:
            return False
    return True

def get_motivation():
    import random
    return random.choice(MOTIVATIONAL_QUOTES)

def get_max_day(week):
    week_data = DAYS_DATA.get(week, {})
    return max(week_data.keys()) if week_data else 6

def get_weeks():
    return list(DAYS_DATA.keys())

import sys
from io import StringIO

def run_code(code):
    old_stdout = sys.stdout
    old_stderr = sys.stderr
    sys.stdout = StringIO()
    sys.stderr = StringIO()
    
    try:
        exec(code, {})
        stdout_output = sys.stdout.getvalue()
        stderr_output = sys.stderr.getvalue()
        
        if stderr_output:
            return "Ошибка: " + stderr_output
        return stdout_output if stdout_output else ""
    except Exception as e:
        return "Ошибка: " + str(e)
    finally:
        sys.stdout = old_stdout
        sys.stderr = old_stderr
